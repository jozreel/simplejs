var http = require('http');
var https = require('https');
var util = require("util");
var url = require('url');
var path = require('path');
//var os= require('os');
var simple = require('simple');
var simple_js =function()
{
	//review might need to remove initializing code
	this.server = this.create();
	this.secureserver = this.createSecure();
	this.reqs =null;
	this.resp=null;
	this.loadable =new  Array();
	this.wsock = new Array();
    this.middleware = new Array();
	return this;
}
var objtt;
simple_js.prototype.create =function(){
var server =http.createServer(app);
server.on('upgrade', function(req,socket,head)
{
   
	var ws = require('websocket');
	//create an array to hold these objects and call senddata onit when ready
	var websoc = new ws(req,socket,head);
	websoc.upgrade();
}
);
objtt=this; 
 
 return server;
} 

simple_js.prototype.createSecure =function(){
var fstm = require('fs');
var config =  require('../config/config');
var options = {key:fstm.readFileSync(config.keys+'/'+'key.pem'), cert:fstm.readFileSync(config.keys+'/'+'cert.pem')};



var server =https.createServer(options,app)
server.on('upgrade', function(req,socket,head)
{
	var ws = require('websocket');
	//create an array to hold these objects and call senddata onit when ready
	var websoc = new ws(req,socket,head);
	websoc.upgrade();
});

 objtt=this;
 return server;
}



simple_js.prototype.createSock=function(host,port)
{
	
	var cfg = require('simple').config;
	var netsoc = require('simplesock');
	var ws= new netsoc();
	 ws.req = this.reqs;
	 ws.create().listen('1338');
	
}



function app(req,res)
	{ 
        
        var method = req.method;
		var config = require('simple').config;
		var obj = objtt;
        obj.notstatic= false;
		var uril = req.url;
		var urlparts = url.parse(uril,true);
		var stfy = util.inspect(urlparts);
		var nn = util.inspect(urlparts.query);
		var tt="";
		var ct = '';
	     tt = urlparts.pathname.slice(1);
		if(tt.slice(-1) === '/')
		{
			tt=tt.slice(0,-1);
		}
        req.basepath = tt;
		var pthnm =tt.split('/');
		var ctrl = pthnm[0];
		var pth = ctrl;
		req.ctr = ctrl;
        if(req.ctr === '')
          req.ctr = config.defaultcontroler;
		var ctr;
		var reslv;
		obj.reqs= req;
		obj.resp=res;
		if(pthnm.length !=1 && pthnm[0] !='favicon.ico')
		{
		try{
		reslv = require.resolve('../application/controller/'+ctrl);	
		var ext = path.extname(reslv);
		var fn = path.basename(reslv.slice(0,-ext.length));
        ctr = require('../application/controller/'+fn);
        var smctr=new simple.simplecontroler();
        ctr.__proto__= smctr;
        var ctro = Object.create(ctr);
		if(reslv !==undefined)
		{
         ctro.method = method;
         obj.notstatic = true;
	     obj.loadtoreq(req, res, obj);
		 pthnm.shift();
		 var rexp = new RegExp(/\.[a-zA-Z]+$/);
		 if(ctro[pthnm[0]]!==undefined)
		  {
		   var splitpath = 	urlparts.path.split('/');
		   if(splitpath.length > 3 || !rexp.test(urlparts.path))
		   {
		     obj.reqContent(pthnm,ctro,req, res,urlparts.query);
		   }
		   else
		   {
			    obj.notfound(res);
		   }
		  }
		  else
          {
			  
			  obj.notfound(res);
		  }
		}
		else{}
		}
		catch(e)
	    {
		  if(reslv===undefined)
		   {
               obj.loadStatic(req.url,function(err, data)
			   {
                   obj.stic(res,req, err,data,pthnm.join('/'));
			   },res);
		   }
		}
		}
		else if(pthnm[0] !== ''&& pthnm[0] !=='favicon.ico')
		{
            try{
                reslv = require.resolve('../application/controller/'+pthnm[0]);
		        if(reslv !== undefined)
                {
                    var ext = path.extname(reslv);
		            var fn = path.basename(reslv.slice(0,-ext.length));
                    ctr = require('../application/controller/'+fn);
                    var smctr=new simple.simplecontroler();
                    ctr.__proto__= smctr;
                    var ctro = Object.create(ctr);
                    if(ctro !== undefined)
                    {
                        obj.notstatic = true;
                        obj.loadtoreq(req, res, obj);
                        pthnm = [config.defaultpage];
                        obj.reqContent(pthnm,ctro,req, res,urlparts.query);
		            }
                }
		        else
                {
                    res.writeHead(400,{'content-type':'text/plain'});
			        res.end('{"message":"NOT FOUND","code":"400"}');
		        }
            }
			catch(error)
			{   
				simple.global.logerror(error);
				res.writeHead(400,{'content-type':'text/plain'});
			    res.end('{"message":"NOT FOUND","code":"400"}');
			}
		}
	    else if(req.url == '/')
		{
            try{
                reslv = require.resolve('../application/controller/'+config.defaultcontroler);	
                if(reslv !== undefined)
                {
                    var ext = path.extname(reslv);
                    var fn = path.basename(reslv.slice(0,-ext.length));
                    ctr = require('../application/controller/'+fn);
                    var smctr=new simple.simplecontroler();
                    ctr.__proto__= smctr;
                    var ctro = Object.create(ctr);
                    if(ctro !== undefined)
                    {
                        obj.notstatic = true;
                        obj.loadtoreq(req, res, obj);
                        pthnm = [config.defaultpage];
                        ctro.method = method;
                        obj.reqContent(pthnm,ctro,req, res, urlparts.query);
                    }
                }
                else
                {
                    res.writeHead(400,{'content-type':'text/plain'});
                    res.end('{"message":"NOT FOUND","code":"400"}');
                }
            }
            catch(error)
            {
                res.writeHead(400,{'content-type':'text/plain'});
			    res.end('{"message":"NOT FOUND","code":"400"}');
            }
        }
		else
		{
            res.writeHead(400,{'content-type':'text/plain'});
			res.end('{"message":"NOT FOUND","code":"400"}');
		}
	        	
	}




simple_js.prototype.reqContent = function(pthnm ,ctr, req,res,quer)
{
	 var obj=this;
     var methd =pthnm[0]; 
	 req.callmethod = methd;
	 ctr.create(res, req);
	 pthnm.shift();
	 var qs = require('querystring');
	if(req.method==='POST' || req.method==='PUT' ||req.method==='PATCH')
	{  
		var body = '';
		var ob ='';
		var ar =[];
		req.on('data', function(data)
		{
		try{
	     body+=data;
		  if(body.length > 1e6) {
                body = "";
                res.writeHead(413, {'Content-Type': 'text/plain'});
				res.end();
                req.connection.destroy();}
		}
		catch(err)
		{
			simple.global.logerror(err);
			
		}
		});
		req.on('end', function() {
			try{
				
			if(req.headers['content-type'].search('multipart/form-data') !== -1)
			{
				
				var boundry =req.headers['content-type'].split(';');
				
				var sep = "";
				
				for(var b in boundry)
				{
					if(boundry[b].search('boundary') !== -1)
					{
						var arr =boundry[b].split('=');
						sep = arr[1].trim();
					}
				}
				
				
				    req.postdata = obj.parse_multipart(body, sep);
				
				 
				
			}
			else{
			  if(body.slice(0,1) ==='{' && body.slice(-1) ==='}')
			  {
				
				//TRY CATCH FOR ERRORS
				try{
					req.postdata = JSON.parse(body);
				}
				catch(e)
				{
				console.log(e);
				  var BD = JSON.stringify(body)
				  req.postdata = JSON.parse(BD); 	
				}
				
				 
			  }
			  else
			  {
	           req.postdata = qs.parse(body);
			  }
			}
            
		    ctr[methd].apply(ctr,pthnm);
		}
		catch(err)
		{
			simple.global.logerror(err);
		}
        });
		
	}
	else
	{
	
	  if(pthnm.lenght >0)
	  {
		  
		    pthnm = pthnm.map(function(x){return simple_js.replacesuspicioscont(x);});
		 // console.log(pthnm);
	  }
	  if(Object.keys(quer).length !== 0)
	  {
		  
			 for(var att in quer)
			 {
			    //console.log(att);
			    quer[att] = this.replacesuspicioscont(quer[att]);
			 }
	
		   req.requestdata = quer;
		
	  }
	  
       ctr[methd].apply(ctr,pthnm);
       
	}
		  
		
}
simple_js.prototype.parse_multipart=function(body,sep)
{    var arr = []; 
   
	 var str='';
	 var lastittern = 0;	
	 var main={};
	 var lastitter=false;
	 cnt = 0;
      
    // var bdy = body.trim();
   var patt = /^\s*\r\n/m;
  // var patt = /^$/m;
    var m;
    while(m!==null)
    {
    
    ms ='--'+sep+'--';
   
    if(ms.length == body.trim().length)
      break;
    if ((m = patt.exec(body)) !== null) {
    if (m.index === patt.lastIndex) {
        patt.lastIndex++;
     }
    
    var headervals = {};
    headers = body.substring(0,m.index);
    
    body = body.slice(m.index,body.length);
    data = body.substring(0,body.indexOf('--'+sep));
    body = body.slice(body.indexOf('--'+sep),body.length);
    //   console.log(headers);
    headers = headers.replace(/\r/g,'');
   
   
    var hds = headers.split('\n');
    hds.splice(0,1);
    if(hds.length === 0)
     continue;
    var fm = hds[0].split(';');
    var spv =fm[0].split(':');
    headervals[spv[0]]=spv[1];
  
    for(i=1; i<fm.length; i++)
     {
         
         firsteq = fm[i].indexOf('=');
         var n;
         if(firsteq !== -1)
         {
           n = fm[i].substring(0,firsteq);
           n = n.trim();
           v = fm[i].substring(firsteq+1, fm[i].length);
         }
       headervals[n] = v;
     }
     if(hds.length >1)
     {
        var ctype = hds[1];
        csp = ctype.split(':');
        headervals[csp[0]]=csp[1];
     }
    // console.log(headervals);
    if(headervals['Content-Type']!==undefined)
     {
         
         name = headervals['name'];
         name =JSON.parse(name);
        
         delete headervals['name'];
         delete headervals['Content-Disposition'];
         headervals.data=data.trim();
         if(main[name] !== undefined)
         {
             tname = main[name];
             main[name]=[];
             main[name].push(tname);
             main[name].push(headervals);
         }
        // else if(typeof main[name] === 'object')
          // main[name].push(headervals)
         else
           main[name]=headervals
     }
     else
     {  var n = headervals['name']
          n =JSON.parse(n);
         if(main[n] !== undefined && typeof main[n]!== 'object')
         {
             tname = main[n];
             main[n]=[];
             main[n].push(tname);
             main[n].push(data.trim());
         }
         else if(typeof main[n] === 'object')
           main[n].push(data.trim())
         else
           main[n]=data.trim();
     }
    }
    }
 

return main;
}
simple_js.prototype.extractName =function(ar,val)
{var pecies = [];
   console.log(ar);
	for(var it in ar)
	{ var a = ar[it].search("name=")
		if(a !== -1)
		{ 
			var rspt =  ar[it].split("=");
			var mar = [];
			mar.push(rspt[1]);
			mar.push(val);
			
			
			pecies.push(mar);
		   break;
		}
	}
	//console.log(pecies);
	return pecies;
}

simple_js.prototype.listen=function(server ,port)
{
	var srv = server;
	var prt = port;
	srv  = typeof srv !== 'undefined' ?  srv : 'localhost';
	prt  = typeof prt !== 'undefined' ?  prt : 80;
	this.server.listen(prt,srv);
}
simple_js.prototype.securelisten=function(server ,port)
{
	var srv = server;
	var prt = port;
	srv  = typeof srv !== 'undefined' ?  srv : 'localhost';
	prt  = typeof prt !== 'undefined' ?  prt : 4433;
	this.secureserver.listen(prt,srv);
}
simple_js.prototype.apply = function(libname ,obj)
{ 
	
	
	this.loadable.push({lib: libname, call: obj});
	return this;
	
}

simple_js.prototype.loadtoreq = function(req, resp, contxt)
{
	var lib = '';
	var objt=this;
req.viewpath = function(vname)
{
	
	var cfg = require('../config/config');
	var tpath ='';
	var path1 = cfg.viewpath + '/shared/'+vname+'.html';
	var path2 = cfg.viewpath +'/'+req.ctr+'/'+vname+'.html';
	path1 = path.normalize(path1);
	path2 = path.normalize(path2);
	if(objt.findbyconvention(path1))
	  return path1;
	else if(objt.findbyconvention(path2))
	  return path2;
    else return tpath;
	//console.log(tpath);
	//return tpath;
}
for(var lb in contxt.loadable)
 {
		var li = contxt.loadable[lb].lib;
		var lib1 =  require('../library/'+li);
	    lib = new lib1(req,resp);
		
	   var ob = contxt.loadable[lb].call;
	for(var va in ob)
	{

		lib[va] = ob[va];
	}
	req[li] = lib; 
	resp[li]=lib;	
	} 
 
 if(this.notstatic === true)
 { 
 for(var middleware in contxt.middleware)
  {
   
    var mw = contxt.middleware[middleware];
    
    if(mw.path !== undefined && tt == mw.path)
    {
        mw.function(req,resp);
    }
    else if(mw.path === undefined)
    {
      
      mw.function(req,resp);
    }
   
          
 }
 }
    
    
    
	return this;
}



simple_js.prototype.loadStatic=function(fname , callback,res)
{  
	if((res.cache !== undefined && !res.cache.cacheFile(fname)) || res.cache === undefined)
	{
	var pt = require('path');
	var cfg = require('../config/config');
	var fs = require('fs');
	var path = cfg.publicpath + '/'+fname;
	path = pt.normalize(path);
	   fs.readFile(path, callback);
	}
			  
			  
			  
			
	
}
simple_js.prototype.use= function(path,callback)
{  console.log(arguments.length);
    if(arguments.length === 1)
    {
        callback = path;
        path = undefined;
    }
    this.middleware.push({function:callback, path:path});
    return this;
}

simple_js.prototype.findbyconvention = function(path)
{
	
	var fs = require('fs');
	try{
	var ststsync = fs.statSync(path)
	return true
	}
	catch(err)
	{
		//console.log(err);
		return false;
		
	}
}

simple_js.prototype.notfound =function(resp)
{
	//console.log('nf');
	resp.writeHead(404, {'Content-Type':'text/html'});
	resp.end("404 : content not found");
}

simple_js.prototype.isimage = function(fname, res,req,data)
{
    
	var imgexts= new Array('.jpg', '.gif', '.png', '.bmp', '.ico', '.jpeg');
	
	var ext = path.extname(fname);
	
	if(imgexts.indexOf(ext) !== -1)
	 { 
		   
		 if(res.cache !== undefined && !res.cache.cacheFile(fname))
		      res.cache.writemime(ext.slice(1),fname,'image');
	    // if(res.cache === undefined)
		   this.outputtores(ext.slice(1),data,'image',res);
		 return true;
	 }
	 else
	    return false;
	
}

simple_js.prototype.isstyle=function(fname, res, req, data)
{
	
	var ext = path.extname(fname);
	var mime = 'text';
	if(ext == ".css")
	{
	 
			 if(res.cache !== undefined && !res.cache.cacheFile(fname))
		       res.cache.writemime(ext.slice(1),fname,mime);
			// else if(res.cache !== undefined)
			    this.outputtores(ext.slice(1),data,mime, res);
		 
		 return true;
	 }
	 else
	    return false;
}

simple_js.prototype.isfont=function(fname, res, req, data)
{
	var fonts= new Array('.ttf', '.woff','.otf','eot');
	
	var ext = path.extname(fname);
	var mime = 'font';
	if(fonts.indexOf(ext) !== -1)
	 {
		// console.log(ext);	  
		 
			  if(ext ==='.woff')
			  {
				  mime = 'application';
				ext = '.font-woff';
			  }
			  if(ext==='.eot')
			  {  mime='application';
				  ext = '.vnd.ms-fontobject';
			  }
			  if(ext=='.otf')
			  {
				 ext = '.opentype'; 
			  }
			 if(res.cache !== undefined && !res.cache.cacheFile(fname))
		       res.cache.writemime(ext.slice(1),fname,mime);
			// else if(res.cache !== undefined)
			    this.outputtores(ext.slice(1),data,mime, res);
		 
		 return true;
	 }
	 else
	    return false;
}
 simple_js.prototype.stic=function(res,req,err,data,fname)
 {
	 try{
		 
	     if(err)
			throw err;
	    var ext = path.extname(fname);
		var mime = 'text';
		if(ext === '.json')
		  mime = 'application';
		if(!this.isimage(fname,res,req, data) && !this.isfont(fname,res,req, data)&&!this.isstyle(fname,res,req, data))
		{
			if(res.cache !== undefined && !res.cache.cacheFile(fname))
		      res.cache.writemime(ext.slice(1),fname,mime);
			//else if(res.cache == undefined)
			  this.outputtores(ext.slice(1),data,mime, res);
			 
			   
			 
		 	//res.end(data.toString());
		}
	    }
	  catch(e)
			{
                   //console.log(e);
				   res.writeHead(404, {'Content-Type':'text/html'});
	               res.end("404 : content not found");
				   //console.log(e);
							
			}
 }
 
simple_js.prototype.outputtores =function(ext, data,mime,res)
{
	//console.log(fname);
	
    //console.log(obj.reqs);
	if(res.compress !==undefined && res.compress.compress === true)
			 {
				  var zlib = require('zlib');
				  //var raw = fs.createReadStream('index.html');
				  if (res.compress.acceptEncoding.match(/\bdeflate\b/)) {
                     zlib.deflate(data, function (err, buffer) {
						 if (err) throw err;
							  res.writeHead(200, { 'content-encoding': 'deflate' },{'Content-Type':mime+'/'+ext});
						  if(mime !=='text' && mime !=='application')
	                        res.end(buffer,'binary');
						else
	                       res.end(buffer);
							 
					  
					 });
                     } 
					 else if (res.compress.acceptEncoding.match(/\bgzip\b/)) {
						  zlib.gzip(data, function (err, buffer) {
						 if (err) throw err;
                           res.writeHead(200, { 'content-encoding': 'gzip' },{'Content-Type':mime+'/'+ext});

						  if(mime !=='text' && mime !=='application')
	                          res.end(buffer, 'binary');
						else
	                       res.end(buffer);
						 
						 
                   });
			 }
			 }
			 else
			 {
				         if(mime !=='text')
	                        res.end(data, 'binary');
						else
	                       res.end(data.toString());
					
			 }
}


simple_js.prototype.replacesuspicioscont=function(txt)
{
	//console.log(txt);
	return txt.replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
}


module.exports= new simple_js()
//var fs = require('fs');
//for(var i=0; i<1; i++)
//{
// var wtr = fs.appendFileSync('myfile.txt','utf8', 'does it append \n	');
//var wtr = fs.appendFile('myfile.txt', 'does it append \n	' , function(err)
	/*{
		if(err)
		{
			throw err;
		}
		console.log('filw writen');
	});*/
//console.log("hrey");

//}
// var buf = fs.readFileSync('myfile.txt');
 //console.log(buf.toString());
 //console.log(buf.length());
 
 
 
 
